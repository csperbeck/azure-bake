{
    "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "publisherEmail": {
            "type": "string",
            "minLength": 1,
            "metadata": {
                "description": "The email address of the owner of the service"
            }
        },
        "publisherName": {
            "type": "string",
            "minLength": 1,
            "metadata": {
                "description": "The name of the owner of the service"
            }
        },
        "sku": {
            "type": "string",
            "allowedValues": [
                "Developer",
                "Standard",
                "Premium"
            ],
            "defaultValue": "Standard",
            "metadata": {
                "description": "The pricing tier of this API Management service"
            }
        },
        "skuCount": {
            "type": "int",
            "defaultValue": 1,
            "metadata": {
                "description": "The instance size of this API Management service."
            }
        },
        "mutualAuthenticationCertificate": {
            "type": "securestring",
            "metadata": {
                "description": "Base-64 encoded Mutual authentication PFX certificate."
            }
        },
        "certificatePassword": {
            "type": "securestring",
            "metadata": {
                "description": "Mutual authentication certificate password."
            }
        },
        "eventHubNamespaceConnectionString": {
            "type": "securestring",
            "metadata": {
                "description": "EventHub connection string for logger."
            }
        },
        "googleClientSecret": {
            "type": "securestring",
            "metadata": {
                "description": "Google client secret to configure google identity."
            }
        },
        "openIdConnectClientSecret": {
            "type": "securestring",
            "metadata": {
                "description": "OpenId connect client secret."
            }
        },
        "tenantPolicy": {
            "type": "string",
            "metadata": {
                "description": "Tenant policy XML."
            }
        },
        "apiPolicy": {
            "type": "string",
            "metadata": {
                "description": "API policy XML."
            }
        },
        "operationPolicy": {
            "type": "string",
            "metadata": {
                "description": "Operation policy XML."
            }
        },
        "productPolicy": {
            "type": "string",
            "metadata": {
                "description": "Product policy XML."
            }
        },
        "location": {
            "type": "string",
            "defaultValue": "[resourceGroup().location]",
            "metadata": {
                "description": "Location for all resources."
            }
        }
    },
    "variables": {
        "apiManagementServiceName": "[concat('apiservice', uniqueString(resourceGroup().id))]"
    },
    "resources": [
        {
            "apiVersion": "2017-03-01",
            "name": "[variables('apiManagementServiceName')]",
            "type": "Microsoft.ApiManagement/service",
            "location": "[parameters('location')]",
            "tags": {},
            "sku": {
                "name": "[parameters('sku')]",
                "capacity": "[parameters('skuCount')]"
            },
            "properties": {
                "publisherEmail": "[parameters('publisherEmail')]",
                "publisherName": "[parameters('publisherName')]"
            },
            "resources": [
                {
                    "apiVersion": "2017-03-01",
                    "type": "policies",
                    "name": "policy",
                    "dependsOn": [
                        "[concat('Microsoft.ApiManagement/service/', variables('apiManagementServiceName'))]"
                    ],
                    "properties": {
                        "policyContent": "[parameters('tenantPolicy')]"
                    }
                }
            ]
        },
        {
            "apiVersion": "2017-03-01",
            "type": "loggers",
            "name": "exampleLogger",
            "dependsOn": [
                "[concat('Microsoft.ApiManagement/service/', variables('apiManagementServiceName'))]"
            ],
            "properties": {
                "loggerType": "azureEventHub",
                "description": "Description for example logger",
                "credentials": {
                    "name": "exampleEventHubName",
                    "connectionString": "[parameters('eventHubNamespaceConnectionString')]"
                }
            }
        },
        {
            "apiVersion": "2017-03-01",
            "type": "certificates",
            "name": "exampleCertificate",
            "dependsOn": [
                "[concat('Microsoft.ApiManagement/service/', variables('apiManagementServiceName'))]"
            ],
            "properties": {
                "data": "[parameters('mutualAuthenticationCertificate')]",
                "password": "[parameters('certificatePassword')]"
            }
        },
        {
            "apiVersion": "2017-03-01",
            "type": "openidConnectProviders",
            "name": "exampleOpenIdConnectProvider",
            "dependsOn": [
                "[concat('Microsoft.ApiManagement/service/', variables('apiManagementServiceName'))]"
            ],
            "properties": {
                "displayName": "exampleOpenIdConnectProviderName",
                "description": "Description for example OpenId Connect provider",
                "metadataEndpoint": "https://example-openIdConnect-url.net",
                "clientId": "exampleClientId",
                "clientSecret": "[parameters('openIdConnectClientSecret')]"
            }
        },
        {
            "apiVersion": "2017-03-01",
            "type": "identityProviders",
            "name": "google",
            "dependsOn": [
                "[concat('Microsoft.ApiManagement/service/', variables('apiManagementServiceName'))]"
            ],
            "properties": {
                "clientId": "googleClientId",
                "clientSecret": "[parameters('googleClientSecret')]"
            }
        }
    ]
}